<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autorizando Google Calendar...</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .container {
        text-align: center;
        padding: 2rem;
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        background: #f44336;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Autorizando...</h1>
      <div class="spinner"></div>
      <p id="status">Processando autoriza√ß√£o do Google Calendar...</p>
      <div id="error" class="error" style="display: none"></div>
    </div>

    <script type="module">
      import { firebasePromise } from "../src/firebase-config.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");

      async function handleOAuthRedirect() {
        try {
          // Pegar o c√≥digo OAuth da URL
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get("code");
          const error = urlParams.get("error");

          if (error) {
            throw new Error(`Erro OAuth: ${error}`);
          }

          if (!code) {
            throw new Error("C√≥digo OAuth n√£o encontrado na URL");
          }

          statusEl.textContent = "Aguardando login do Firebase...";

          // Aguarda inicializa√ß√£o do Firebase
          const { app } = await firebasePromise;
          const auth = getAuth(app);

          // Esperar usu√°rio estar logado
          const user = await new Promise((resolve) => {
            onAuthStateChanged(auth, (user) => {
              if (user) resolve(user);
            });
          });

          if (!user) {
            throw new Error("Usu√°rio n√£o est√° logado no Firebase");
          }

          statusEl.textContent = "Obtendo tokens do Google...";

          // Trocar code por tokens usando o backend
          const response = await fetch("/api/exchangeCodeForTokens", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              code: code,
              userId: user.uid,
              email: user.email,
              displayName: user.displayName,
              photoURL: user.photoURL,
              redirectUri: window.location.origin + "/pages/oauth2callback.html",
            }),
          });

          if (!response.ok) {
            let errorMessage = `Erro ${response.status}`;
            try {
              const errorData = await response.clone().json();
              const detailMsg =
                (errorData.detail && (errorData.detail.error || errorData.detail.message)) ||
                (errorData.detail && errorData.detail.response && errorData.detail.response.error) ||
                null;
              const baseMsg = errorData.error || errorData.message || "Erro ao trocar c√≥digo por tokens";
              const redirectInfo = errorData.redirectUri ? ` [redirectUri: ${errorData.redirectUri}]` : "";
              errorMessage = detailMsg ? `${baseMsg}: ${detailMsg}${redirectInfo}` : `${baseMsg}${redirectInfo}`;
              console.error("Detalhe do erro OAuth:", errorData);
            } catch (e) {
              try {
                const errorText = await response.clone().text();
                errorMessage = `${errorMessage}: ${errorText.substring(0, 400)}`;
              } catch (_) {}
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();

          statusEl.textContent = "Salvando credenciais...";

          // Salvar tokens no localStorage para uso imediato e persist√™ncia
          if (data.accessToken) {
            localStorage.setItem("googleAccessToken", data.accessToken);
          }
          if (data.refreshToken) {
            localStorage.setItem("googleRefreshToken", data.refreshToken);
          }

          console.log("‚úÖ Tokens salvos no localStorage");

          statusEl.textContent = "‚úÖ Autoriza√ß√£o conclu√≠da!";

          // Redirecionar de volta para o app
          setTimeout(() => {
            window.location.replace("/index.html");
          }, 1500);
        } catch (error) {
          console.error("Erro no redirect OAuth:", error);
          errorEl.textContent = `‚ùå Erro: ${error.message}`;
          errorEl.style.display = "block";
          statusEl.textContent = "Falha na autoriza√ß√£o";

          // Redirecionar mesmo com erro ap√≥s 3 segundos
          setTimeout(() => {
            window.location.replace("/index.html");
          }, 3000);
        }
      }

      // Executar
      handleOAuthRedirect();
    </script>
  </body>
</html>
